# Visual Editing Undo/Redo Implementation

## Overview
Implemented component-level undo functionality for visual editing, allowing users to revert individual component changes without affecting other edits.

## Implementation Summary

### 1. Database Schema ✅
**File**: `packages/database/prisma/schema.prisma`

Added `ComponentEditMetadata` model to track component-level edits:
- Links to fragments and projects
- Stores before/after snapshots of component code (±20 lines context)
- Tracks component identification (shipperId, selector, componentName)
- Supports repeated components (instanceIndex, totalInstances)
- Records change type (style/text/combined)
- Stores actual changes for reference

**Migration**: `20251204000000_add_component_edit_metadata`

### 2. Backend Procedures ✅
**File**: `apps/web/src/modules/projects/server/procedures.ts`

#### Updated `applyDirectVisualEdit`
- Extracts component code snippets (±20 lines around edited element)
- Stores metadata after each visual edit
- Links metadata to created fragment

#### New Procedures
1. **`getComponentEditHistory`**
   - Query edit history for a specific component
   - Filters by projectId, filePath, shipperId, or selector
   - Returns up to N most recent edits (default: 10)
   - Includes fragment information

2. **`undoComponentEdit`**
   - Reverts component to previous state
   - Reads current file from sandbox
   - Applies "before" snapshot to revert changes
   - Validates reverted content
   - Writes back to sandbox
   - Creates new fragment with reverted state
   - Stores undo metadata (for potential redo)

### 3. UI Components ✅
**File**: `apps/web/src/modules/projects/ui/components/VisualEditingPanel.tsx`

#### Added Features
- **Undo Button**: Located in panel footer (left side)
- **Edit History Query**: Fetches last 5 edits for selected component
- **Tooltip**: Shows change type of last edit
- **Loading State**: Shows spinner during undo operation
- **Disabled State**: Grays out when no history available

#### Integration
- Added `projectId` prop to panel
- Added `onFragmentRefresh` callback to refresh preview after undo
- Uses tRPC query and mutation hooks

**File**: `apps/web/src/modules/projects/ui/view/v3-project-view.tsx`
- Passes `projectId` to VisualEditingPanel
- Provides `onFragmentRefresh` callback that refreshes preview

## How It Works

### Visual Edit Flow
1. User selects component in visual edit mode
2. User makes style/text changes
3. User clicks "Apply Styles"
4. `applyDirectVisualEdit` procedure:
   - Extracts component code (±20 lines)
   - Updates file in sandbox
   - Creates new fragment
   - **Stores ComponentEditMetadata** with before/after snapshots
5. Preview refreshes with changes

### Undo Flow
1. User clicks "Undo" button in visual editing panel
2. `getComponentEditHistory` query fetches edit history
3. `undoComponentEdit` mutation:
   - Retrieves edit metadata
   - Reads current file from sandbox
   - Replaces edited section with "before" snapshot
   - Validates reverted content
   - Writes back to sandbox
   - Creates new fragment with reverted state
   - Stores undo metadata (swapped before/after)
4. Preview refreshes showing reverted state
5. Panel closes

## Component Identification

### Primary: shipperId
- Format: `"filename:line:column"` (e.g., "App.tsx:42:4")
- Generated by Vite plugin
- Most reliable for locating components
- Used to extract ±20 lines of context

### Fallback: selector
- CSS selector (e.g., "div.container > button.primary")
- Used when shipperId not available
- Less precise but still functional

### Repeated Components
- Tracked via `isRepeated`, `instanceIndex`, `totalInstances`
- Ensures correct instance is reverted
- All instances share same shipperId

## Storage Strategy

### Snapshot Size
- Stores ±20 lines around edited element (configurable)
- Balances context vs storage size
- Sufficient for most component edits

### Fallback
- If no shipperId: stores entire file
- Less ideal but ensures undo still works

## Future Enhancements

### Redo Functionality
- Metadata already stored with swapped before/after
- Can implement redo by:
  1. Tracking undo operations
  2. Applying "after" snapshot from undo metadata
  3. Creating new fragment

### History Panel
- Show list of all edits for component
- Allow jumping to any previous state
- Visual diff between states

### Keyboard Shortcuts
- Cmd+Z / Ctrl+Z for undo
- Cmd+Shift+Z / Ctrl+Shift+Z for redo

### Conflict Resolution
- Handle cases where component was edited multiple times
- Merge changes from different edits
- Detect and resolve conflicts

### Performance Optimizations
- Compress snapshots for large components
- Implement efficient diff/patch algorithms
- Cache edit history queries

## Testing Checklist

- [ ] Single component edit → undo
- [ ] Multiple edits to same component → undo each
- [ ] Repeated component edit → undo correct instance
- [ ] Style-only change → undo
- [ ] Text-only change → undo
- [ ] Combined style+text change → undo
- [ ] Undo with no history → button disabled
- [ ] Undo during pending changes → works correctly
- [ ] Preview refreshes after undo
- [ ] Fragment history shows undo fragments
- [ ] Undo button tooltip shows correct change type

## Known Limitations

1. **Line-based snapshots**: If file structure changes significantly, undo may not work perfectly
2. **No redo yet**: Can only undo, not redo
3. **No history panel**: Can only undo last change, not jump to arbitrary state
4. **Storage overhead**: Stores snapshots for every edit (could be optimized with diffs)

## Files Modified

### Database
- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/20251204000000_add_component_edit_metadata/migration.sql`

### Backend
- `apps/web/src/modules/projects/server/procedures.ts`

### Frontend
- `apps/web/src/modules/projects/ui/components/VisualEditingPanel.tsx`
- `apps/web/src/modules/projects/ui/view/v3-project-view.tsx`

### Documentation
- `docs/VISUAL_EDITING_UNDO_REDO_ANALYSIS.md` (analysis)
- `docs/VISUAL_EDITING_UNDO_IMPLEMENTATION.md` (this file)

## Commits

1. `feat: add ComponentEditMetadata model for visual editing undo/redo`
2. `feat: store component edit metadata in applyDirectVisualEdit`
3. `feat: add undo/redo procedures for visual editing`
4. `feat: add undo button to visual editing panel`
